import { Server } from '@chainlink/ccip-read-server';
import chai, { expect } from 'chai';
import chaiAsPromised from 'chai-as-promised';
import { ethers } from 'ethers';
import supertest from 'supertest';
import { makeApp } from '../src/app';
import * as packet from 'dns-packet';
import * as qTypes from 'dns-packet/types';
import { SignedSet } from '@ensdomains/dnsprovejs';

chai.use(chaiAsPromised);

const TEST_ADDRESS = '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266';

const RESPONSES = {
  "example.com": {
    "A": "000181a00001000200000001076578616d706c6503636f6d0000010001076578616d706c6503636f6d0000010001000140a700045db8d822076578616d706c6503636f6d00002e0001000140a7009f0001080200015180640422b363e82cfa451f076578616d706c6503636f6d003d17b7efbc00e19ebde72cb0ba150ddffa15f3970d1d2dff61cc64e32e60afe4371bec3351d0cf22b569e8098c64bb3a4ca6233c57425a6a7253daa351268f46534197448276c34723cb220786ea44f4434ef6e1710117393a851b7f6cacc50b8ce0ceed607771c413ca5a31919f24e522b92c07554a3406850564237e185c4100002904d0000080000000",
    "DNSKEY": "000181a00001000500000001076578616d706c6503636f6d0000300001076578616d706c6503636f6d00003000010000013900880100030803010001bf22e0960d3b878b7848cdff833c7385eeac47c5b21ac045db474d25fe76810a2ed96d6f72604cd20127837b892caf0c3696c82bc79f724a191a780de7ebfead30731823a5e3889b8fdaa84fa96c28656b5d080337fc6e8bac1b8a45fd2cc779a0c9092ec5f4beb59fe6db037f91c2bce3b74ed79cb71d0cfbde4f36ecf40ccb076578616d706c6503636f6d000030000100000139010801010308030100019d1aaaed6b27aa2b2729eb45f3693e66b2259a00c7d21cdbf465f554162cc1f28f1c5e9b75544a83542055c44506e3d00f4e829d330ccf5821c70a2d177a2e65a20c2b7b50943155d0fe85e6f911ce2a96a1a6c97f4c0da6e4bd7d8dbccc2c51e71b601abca177934fd2d198252df4a52dfd63a2e832840b1a06fdb593ca4ad7c8147c7a50fe490638dce0158e55ab565b47c60a78feb8410af45b99d7e5ba768f220bb6ede1365389b20d22d3f1ae00d2b079b871b83e439af5d211b3dcb4d0cda659fe25c8f79eeef8b97dec3675b6b21d79a278671a007af1efa34600005e637f77c639660cd714905d60a4d59495ae1f5996db69843303dde62ddae783e3076578616d706c6503636f6d00003000010000013901080101030803010001b38503197e2e4b7450c825662cca102d40c54bbcce58fae4a61ab51e7005632b875f136332bf8a0e98d6de584d608eebc6f29e8ae936ef5fa8d1402d7edb565f7f8326c0d2fd04845f9d8179a851f457ee4b0c1a006fb5f6b6fd8f5ade495734baa44eccc84383c43150a3b6bca5d7d05ef7f3e415e0bd2138e031142c421981dfd7b23189da97e7f76d4c4a9387eaedcb8453475b469b9ee07fcdea33ee71758ec22300913261821aa0cbea3d15f229fad47f7a629aa3de3fc295570dc3dfe41d7c8fbc73d92bd34f18aea82cc232db319e29191dca21d63e20f98d41f3320c22fac433ea591a187f62e7f847008181a6028bd86988c595bd2e16073c74fe55076578616d706c6503636f6d00002e000100000139011f0030080200000e1063fcc47d63e0b5817aae076578616d706c6503636f6d006431702440bb96dd87902da667d6c75de2537852bae7ef6050e5abbe7d4cbbc9406677f233715f75cd6c4b5cd60780cd2c58980dab6926acca0d302bf8faa5348e9336f855054578398704300314b0174482e412c61a05b688d766f0251df95403fcc3ff330a6f42f0085efcc3aa215f40bd7ae89ad97c3d88e781e57c08cb447edcf0c5f375371a8e8a03eeb71d2fbcd601ced63326cbee51075abb15d8b39bb1e4e4a6df469ac81f205094e5085f4de4d8d9dd150b3544a3268629162367dc1463729d64faacd029eac468e40f2f1388085b1d19792bdc1c3d2b920bfd6a4a18cbb31c7256038f30923706063cfd26266c299d3f59bd82e7d9f2b1e9f99ae1076578616d706c6503636f6d00002e000100000139011f0030080200000e1063fcc47d63e0b581b234076578616d706c6503636f6d000fced12b2d2a5a316a221995084532f58f0ab9874bfb06196c81658f675fc399673620a42ee5ff8e70f354e08d105c23a8e914534e0256ee3242cc9262e0c1581205b2c12aca0a7c1c9be3989684c65d9cca166886052e66a8fb53886c61dab48bcde700994760d03b2f961838e11d0fc2c91418d74b2eb730726b6b83cbd78ad8c995af6cf2c55cc16825b6ab6798fbe7caa6f216c4130c1c2828f11a194f464f7166fa9ceb5c216221b91cbe693487c2b961e03122d033f4437948c6d17e80cea20275e0705b53d2a81d820e5cc9eb1a849ebe5f1aee800648e3e78dcbdb7d22af1f7752e394287be20c4597ff97375f214b2c60d45a5b98c4fbcb7e82aa3600002904d0000080000000",
    "DS": "000181a00001000700000001076578616d706c6503636f6d00002b0001076578616d706c6503636f6d00002b00010001496700187aae0801189968811e6eba862dd6c209f75623d8d9ed9142076578616d706c6503636f6d00002b00010001496700247aae0802f78cf3344f72137235098ecbbd08947c2c9001c7f6a085a17f518b5d8f6b916d076578616d706c6503636f6d00002b00010001496700187b6508013490a6806d47f17a34c29e2ce80e8a999ffbe4be076578616d706c6503636f6d00002b00010001496700247b650802cde0d742d6998aa554a92d890f8184c698cfac8a26fa59875a990c03e576343c076578616d706c6503636f6d00002b0001000149670018aa1b0801b6225ab2cc613e0dca7962bdc2342ea4f1b56083076578616d706c6503636f6d00002b0001000149670024aa1b0802615a64233543f66f44d68933625b17497c89a70e858ed76a2145997edf96a918076578616d706c6503636f6d00002e00010001496700b7002b08020001518063f05f0363e7141b8f8303636f6d009a345ce749473a45491d8e8228489dd5ab0ce1cac01be6201e4492264d8c39e95bf967547005b959947a6014a0db7d54ab624993ad8d2129c270b2b5aecfbad55d0161f23683d94602b01378171965de4fe7b86c87d5fdcde5a9b5526909a988ef4d46fcfc887d9cdd3db7d68f2dd859d7c17f2e5e89fe8cfa32f3b29c2903c4d7931c4f1dc452f1c30ded9225ca874448ff456a5302c74e83284ef97bb2894f00002904d0000080000000"
  },
  "com": {
    "DNSKEY": "000181a0000100030000000103636f6d000030000103636f6d00003000010000177600a80100030803010001bf9c0a09e4ac0060149ebb96e97303fac9b5c9e300b07f80fdd0df73dda4d9775685bf574196ce8f7d17b23b1722bf9694538283e9da97b60d1b68a1c2fd5e1a95a040c3574e0a3e4ea425769c4a996d7fdc6efe3fac24494e1b3fdc5b303120ddac4c9c6c472351c1e9d32c92ddd692c3a81f34841db985ef7f7766f09ae5a10bb97b987ad7af4460be4c4619278ffe4d0c420ec91b3975982f8fff2ab0c7a103636f6d0000300001000017760106010103080103c3ce574d98cbd9157e0d70d274b849ca0e0eed9affc5dccc9047496906655c35cb08b33c4d171b017ca356f4960262aa6293cdfae8b13b55b21c351cdfa7687d38ef07465f87f84d3ccdab8af24edebd6126bbfea877ed9ba2080fa2211f18dcaf34f69223b14e22ba03b27c3fb5a820cc7457d59ed23a23a23d63cd230494c96399efd566710d462e40ba36562f1b71f0626ca742fea81701affca10b4b0ed949dadb4d0d075ef65ba8c508ec168cb249af826d46ee8299d58885ecef62a1535cd3eec049baa664ded9f7c10653f421d8afc18147bc1ecd1755c74f2abb72627a101dddb29ca3dc30c953122876ff61c31e344f2766b2c08a4a367bf8a0fa3f03636f6d00002e0001000017760117003008010001518063f900d563e5392978bd03636f6d00470dca38d1f1c67d5bc7e70fabefa3761464954d59e613b0b46e7189c743df8db5410839f1bff44f1b157c46aece78d10187c3395d107faa55f53a7ff5fd9ae3d62751449e044b403258f72c4f4a81fe997fb6b0dfd74706c68e80035d31efbb3e6d26fae5bbdc6056fa9b794b999a33b297e5675da294f650f40db63ca4888688b47e1d2f48628c0ee0e4c868bd6fec298472ee5c128300ac60886a4122b163010fbe68bfb0e696cd80bf97a0575a2e30ee5ebc54b52085e0d6941ae4ad2261e1c451bbacf726441296fbc278eda58f0c52c2cf8fa7aa263e5b0f1b9c8d967c614895baf21a47e0a55936901595857bdc2f109c58e6cc54479b56397353509500002904d0000080000000",
    "DS": "00018580000100020000000103636f6d00002b000103636f6d00002b000100014721002478bd0802e2d3c916f6deeac73294e8268fb5885044a833fc5459588f4a9184cfc41a576603636f6d00002e0001000147210113002b08010001518063fa3e9063e90d0003b700a8d1358c0509b2c11618794e8c6afc6f8b5d32bb43659fa92c743575ad0298384f288489b35bd82021254118cbf1ded99e1916735323d85537cba365cc9ad1f1eec4539359dc5baa189b21d7f13773368600ba1fb5f0b683b65f8ef62d123f7511c6b80683ec8f4507b8c50ea9bec654c85bd6865161addb6ed56fb28898ef22c26299af89a411a2f6a43f3d7c64bffcb6aa733f16785b88d4623b6940bb2f3b89c45d35ada64a2e290c7d6ea74fd2574d1bd391f8998d4be29d4ec73e82c918df6bf8cfd2fc467aaa80df62669635a9d7f0e000ec599b9c41436cecc516aa894b1789a9a0d1edd5dae4c331c65e42e92b6424112e36e56b06cdb8c57696555b00002904d0000080000000"
  },
  ".": {
    "DNSKEY": "000185800001000300000001000030000100003000010002a30001080100030803010001c5673b68d9171e3be7a45bff2021267b25ef679e9ac39b538de7725997c2a749969fa40b95908c6624a8b4f9c6469408f864af834a2cbac80595de4866b373a831ff2aeb32d5295dc42f6b1ea47c324f4eef7be0e99e11bb63cb23fb646e6d51f4b0356b7fe04bb10cd9994c4486f2353464b8d8201d75a4ad2049741b3153f22321ad1461cc3f1e94c569facd4ce910259115ba84be403a635df3789d631b64648bfcecedafe8d7715397f908f74d77121ea5e8a736cf16dcd78192f1fa4cd3fc5022b659c9e8978ffd82e1172c3dea96b8d8fd9b4a9242b6eb099b4b1dbdb453cc75bae7b88b0497f72ecba7065deaf8d877577a76005ad57c6073f4c2fa6f00003000010002a30001080101030803010001acffb409bcc939f831f7a1e5ec88f7a59255ec53040be432027390a4ce896d6f9086f3c5e177fbfe118163aaec7af1462c47945944c4e2c026be5e98bbcded25978272e1e3e079c5094d573f0e83c92f02b32d3513b1550b826929c80dd0f92cac966d17769fd5867b647c3f38029abdc48152eb8f207159ecc5d232c7c1537c79f4b7ac28ff11682f21681bf6d6aba555032bf6f9f036beb2aaa5b3778d6eebfba6bf9ea191be4ab0caea759e2f773a1f9029c73ecb8d5735b9321db085f1b8e2d8038fe2941992548cee0d67dd4547e11dd63af9c9fc1c5466fb684cf009d7197c2cf79e792ab501e6a8a1ca519af2cb9b5f6367e94c0d47502451357be1b500002e00010002a3000113003008000002a3006401388063e589004f66008f7f14425df46b204b784239e4662e13c226426f28ea58ecd8b9547d258e236ab5dbf5b04d09a90ca4d152bd75e81e00d1a520ba3f179780b571a11d019eb9f1cba0835bbd6b926bf9498237f24834f0acd76c9e90f484cfde4a26f85b432b134fae8373260d9e745790ea84a5acb63b815005a335aa18db2bc966bd067680ac1b441dc58e787e9121b8e12e80097384d59f27fc38e321f7008ee401881e0f1355d867da90a7796bfa8dc2f9cde481d4fd11dc0d6e34871cfaa0de9354d440d8db72e6d491f0e648ade4b40e5983ee41b8aa2d1968860a5fdc11619ee6488056d2f0d7ff9e03238b8966c0f1d024d09f6983b6557777afcc3d73d53b224fd9fc00002904d0000080000000"
  }
}

function makeQueryFunc(responses: {[qname: string]: {[qtype: string]: string}}) {
  return function(q: packet.Packet): Promise<packet.Packet> {
      if(q?.questions?.length !== 1) {
          throw new Error("Queries must have exactly one question"); 
      };
      const question = q.questions[0];
      const response = responses[question.name]?.[question.type];
      if(response === undefined) {
          throw new Error("Unexpected query for " + question.name + " " + question.type);
      }
      return Promise.resolve(Object.assign(packet.decode(Buffer.from(response, 'hex')), {questions: q.questions, id: q.id}));
  };
}

function compareSignedSets(ssdata: {rrset: string, sig: string}, adata: string) {
  const signedset = deserializeSignedSet(ssdata);
  const ssrecord = Object.assign({}, signedset.records[0], {ttl: undefined});
  const answer = packet.decode(Buffer.from(adata, 'hex'));
  const arecord = Object.assign({}, answer.answers?.[0] || {}, {ttl: undefined});
  expect(arecord).to.deep.equal(ssrecord);
}

function deserializeSignedSet(data: {rrset: string, sig: string}): SignedSet<packet.Answer> {
  return SignedSet.fromWire(Buffer.from(data.rrset.slice(2), 'hex'), Buffer.from(data.sig.slice(2), 'hex'));
}

describe('ccip-read-dns-gateway', () => {
  const abi = [
    'function resolve(bytes name, uint16 qtype) returns(tuple(bytes rrset, bytes sig)[])',
  ];

  describe('end-to-end tests', () => {
    it('responds to a DNS query correctly', async () => {
      const iface = new ethers.utils.Interface(abi);
      const calldata = iface.encodeFunctionData('resolve', [
        (packet as any).name.encode('example.com'),
        qTypes.toType('A') // class inet 'A'
      ]);
      const sendQuery = makeQueryFunc(RESPONSES);
      await supertest(makeApp(sendQuery, '/', Server))
        .get(`/${TEST_ADDRESS}/${calldata}.json`)
        .send()
        .expect(200)
        .expect('Content-Type', /json/)
        .then(response => {
          const responsedata = iface.decodeFunctionResult(
            'resolve',
            response.body.data
          )[0];
          expect(responsedata.length).to.equal(6);
          compareSignedSets(responsedata[0], RESPONSES['.']['DNSKEY']);
          compareSignedSets(responsedata[1], RESPONSES['com']['DS']);
          compareSignedSets(responsedata[2], RESPONSES['com']['DNSKEY']);
          compareSignedSets(responsedata[3], RESPONSES['example.com']['DS']);
          compareSignedSets(responsedata[4], RESPONSES['example.com']['DNSKEY']);
          compareSignedSets(responsedata[5], RESPONSES['example.com']['A']);
        });
    });
  });
});
